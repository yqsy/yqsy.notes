---
title: 新服务器搭建
date: 2017-10-22 23:56:44
categories: [linux, 搭建环境]
---

<!-- TOC -->

- [1. 流程](#1-流程)
- [2. centos7](#2-centos7)

<!-- /TOC -->

<a id="markdown-1-流程" name="1-流程"></a>
# 1. 流程

* 创建开发账号,sudo权限,设置证书,禁止密码登录,禁止root登陆
* 操作系统源设置(centos暂时不需要,会自动选择)
* 时区设置,定时从服务器更新时间
* 关闭selinux,iptables
* 文件描述符数量调整
* 内核参数优化
* zsh vim 各种帮助开发/诊断 工具 (可选)
* 监控/报警


<a id="markdown-2-centos7" name="2-centos7"></a>
# 2. centos7

```bash

# 全局限制
sudo bash -c "cat >> /etc/sysctl.conf" << EOF
fs.file-max = 1020000
EOF

# 进程限制
sudo bash -c "cat >> /etc/security/limits.conf" << EOF
*      soft  nofile    1020000
*      hard  nofile    1020000
EOF

# 端口限制
sudo bash -c "cat >> /etc/sysctl.conf" << EOF
net.ipv4.ip_local_port_range = 1024 65535
EOF

# tcp
sudo bash -c 'cat >> /etc/sysctl.conf' << EOF
net.ipv4.tcp_syncookies = 1

# The maximum number of times initial SYNs for an active TCP connection attempt will be retransmitted
net.ipv4.tcp_syn_retries = 1

# Enable fast recycling of TIME_WAIT sockets. 
#net.ipv4.tcp_tw_recycle = 1

# reuse TIME_WAIT sockets
#net.ipv4.tcp_tw_reuse = 1

# ?
# net.ipv4.tcp_fin_timeout = 30

#net.ipv4.tcp_keepalive_time = 1200
EOF

sudo sysctl -p

# 关闭iptables
sudo systemctl stop firewalld && sudo systemctl disable firewalld

# 关闭selinux
sudo setenforce 0
sudo sed -i 's/^SELINUX=.*/SELINUX=disabled/g' /etc/selinux/config

# sshd
sudo sed -i 's@#UseDNS yes@UseDNS no@' /etc/ssh/sshd_config
sudo systemctl restart sshd

# 时区
sudo timedatectl set-timezone "Asia/Shanghai"

# ntp
sudo yum update -y
sudo yum install ntp -y

sudo bash -c 'cat >> /etc/crontab' << EOF
*/5 * * * * root /usr/sbin/ntpdate ntp.api.bz >> /var/log/ntpdate.log 2>&1
EOF


sudo /usr/sbin/ntpdate ntp.api.bz
sudo systemctl restart crond

# 增加账户
sudo groupadd -g 2018 admin
sudo useradd -u 2018 -g 2018 -d /home/yq yq
sudo mkdir -p /home/yq
sudo chown yq:admin /home/yq
sudo chsh -s /bin/bash yq

sudo bash -c 'cat >> /etc/sudoers' << EOF
%admin  ALL=(ALL)       NOPASSWD: ALL
EOF

# 证书
sudo su - yq

curl -O https://raw.githubusercontent.com/yqsy/linux_script/master/id_rsa.pub
mkdir ~/.ssh
chmod 700 ~/.ssh
touch ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
cat id_rsa.pub >>  ~/.ssh/authorized_keys
rm id_rsa.pub -f

sudo sed -i "s/.*PasswordAuthentication.*/PasswordAuthentication no/g" /etc/ssh/sshd_config
sudo systemctl restart sshd

sudo reboot

# 软件

# 速度慢可代理
export http_proxy=http://host1:1080
export https_proxy=http://host1:1080

sudo yum install epel-release git vim net-tools telnet tcpdump htop lsof python34 python34-pip -y

sudo yum install screen -y

# docker
sudo yum install docker -y

sudo groupadd docker
sudo usermod -aG docker $(whoami)

sudo bash -c "cat > /etc/docker/daemon.json" << EOF
{
  "registry-mirrors": ["https://registry.docker-cn.com"]
}
EOF

sudo systemctl start docker
sudo systemctl enable docker

# zsh
sudo yum install zsh -y
sudo chsh $(whoami) -s /bin/zsh

curl -L https://raw.githubusercontent.com/yqsy/vim/master/etc/zshrc.zsh > ~/.zshrc

# pypi
sudo mkdir -p /root/.pip
sudo bash -c 'cat > /root/.pip/pip.conf' << EOF
[global]
index-url = https://pypi.tuna.tsinghua.edu.cn/simple
EOF

sudo pip3 install --upgrade pip

# glances
sudo pip3 install bottle requests
sudo pip3 install glances

```
