---
title: 安全管理
date: 2017-10-23 20:56:18
categories: [linux, 系统管理]
---

<!-- TOC -->

- [1. 学习资源](#1-学习资源)
- [2. 给服务器加上公钥](#2-给服务器加上公钥)
- [3. 客户端使用私钥登录](#3-客户端使用私钥登录)
    - [3.1. linux使用私钥](#31-linux使用私钥)
- [4. agent](#4-agent)
    - [4.1. windows环境](#41-windows环境)
    - [4.2. linux环境](#42-linux环境)
- [5. 关闭root登录](#5-关闭root登录)
- [6. 禁止系统响应任何从外部/内部来的ping请求](#6-禁止系统响应任何从外部内部来的ping请求)
- [7. 限制bash_history记录](#7-限制bash_history记录)
- [8. 删除不必要的用户和组](#8-删除不必要的用户和组)
- [9. 关闭selinux](#9-关闭selinux)
- [10. 设定tcp_wrappers防火墙](#10-设定tcp_wrappers防火墙)
- [11. iptables](#11-iptables)
    - [11.1. 各个链的详细功能](#111-各个链的详细功能)
        - [11.1.1. filter表](#1111-filter表)
        - [11.1.2. nat表](#1112-nat表)
        - [11.1.3. mangle表](#1113-mangle表)
    - [11.2. 选项](#112-选项)
        - [11.2.1. 操作选项](#1121-操作选项)
        - [11.2.2. 过滤选项](#1122-过滤选项)
        - [11.2.3. 注意点,用tcp-reset代替drop](#1123-注意点用tcp-reset代替drop)
        - [11.2.4. 参考书籍的](#1124-参考书籍的)
- [12. 备份(备份不是万能的,但是没有备份是万万不能的)](#12-备份备份不是万能的但是没有备份是万万不能的)
    - [12.1. 数据备份方式](#121-数据备份方式)
    - [12.2. 备份策略](#122-备份策略)
    - [12.3. tar备份案例](#123-tar备份案例)
    - [12.4. rsync备份案例](#124-rsync备份案例)

<!-- /TOC -->


# 1. 学习资源
* https://kb.iu.edu/d/aews (ssh扫盲)
* http://blog.csdn.net/xcbeyond/article/details/38855069 (ssh经验)
* https://www.zhihu.com/question/25912483 (ssh原理)
* https://help.github.com/articles/connecting-to-github-with-ssh/ (github ssh资料)


# 2. 给服务器加上公钥
```bash
# 创建证书文件夹
mkdir /root/.ssh
chmod 700 /root/.ssh

# rz或scp或联系系统管理员上传公钥至服务器
touch ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys

# 增加公钥
cat id_rsa_2048.pub >>  ~/.ssh/authorized_keys

# 禁止密码登陆
sed -i "s/.*PasswordAuthentication.*/PasswordAuthentication no/g" /etc/ssh/sshd_config

# 重启服务
systemctl restart sshd
```


# 3. 客户端使用私钥登录
```bash
# 指定私钥登录
ssh root@45.32.17.217 -i ./id_rsa_2048
```

## 3.1. linux使用私钥
```bash
# 先拷贝上去
pscp ./id_rsa_2048 root@35.194.205.194:/root/.ssh
mv id_rsa_2048 id_rsa

# linux must set ro r--------
chmod 400 ~/.ssh/id_rsa
```

# 4. agent

* https://stackoverflow.com/questions/21095054/ssh-key-still-asking-for-password-and-passphrase
* http://www.unixwiz.net/techtips/ssh-agent-forwarding.html

If you're correctly using SSH when cloning / setting remotes. `Then make sure you have a ssh-agent to remember your password. `That way, you'll only enter your passphrase once by terminal session.

程序|agent
-|-
xshell|Xagent
putty|pageant
git|PLINK.EXE/pageant
tortoisegit|PLINK.EXE/pageant
ssh|ssh-agent


## 4.1. windows环境

```bash
# 通过私钥生成putty ppk
puttygen

# git使用plink,tortoise也设置成这个
设置环境变量GIT_SSH为C:\Program Files (x86)\PuTTY\plink.exe

# 启动PAGEANT
pageant
```

## 4.2. linux环境
```bash
eval `ssh-agent -s`

# linux注意权限
chmod 700 ./id_rsa_2048

ssh-add ./id_rsa_2048

# linux设置启动bash就启动ssh-agent
echo 'eval `ssh-agent -s`' >> ~/.bashrc
echo 'ssh-add /root/id_rsa_2048' >> ~/.bashrc
```

# 5. 关闭root登录
```bash
# TODO 使用sed
vim /etc/ssh/sshd_config
PermitRootLogin  no
```

# 6. 禁止系统响应任何从外部/内部来的ping请求
```bash
echo "1" >/proc/sys/net/ipv4/icmp_echo_ignore_all
```

# 7. 限制bash_history记录
```bash
vim /etc/profile
HISTSIZE=30
```

# 8. 删除不必要的用户和组
```bash
userdel adm
userdel lp
userdel sync
userdel shutdown
userdel halt
userdel news
userdel uucp
userdel operator
userdel games
userdel gopher

groupdel adm
groupdel lp
groupdel news
groupdel uucp
groupdel games
groupdel dip
groupdel pppusers
groupdel popusers
groupdel slipusers
```

# 9. 关闭selinux
```bash
# 查看selinux是否启动
getenforce

vim /etc/sysconfig/selinux
SELINUX=disabled

# 重启
reboot
```


# 10. 设定tcp_wrappers防火墙
> tcp_wrappers是一个用来分析TCP/IP封包的软件,类似的IP封包软件还有iptables,Linux本身有两层安全防火墙，通过IP过滤机制的iptables实现第一层防护,如果通过了第一层防护，那么下一层防护就是tcp_wrappers了,通过tcp_wrappers可以实现对系统中提供的某些服务的开放与关闭、允许和禁止，从而更有效地保证系统安全运行。

* service: 代表服务名,例如: sshd, vsftpd和sendmail等
* host(s): 主机名或者IP地址,可以有多个,例如192.168.60.0,www.ixdba.net
* action: 动作,符合条件后采取的动作
* ALL:所有服务或者所有IP
* ALL EXCEPT: 所有的服务或者所有IP除去指定的

```
/etc/hosts.allow
/etc/hosts.deny
```



# 11. iptables

## 11.1. 各个链的详细功能

### 11.1.1. filter表
链名称|链作用
-|-
INPUT链|主要是对外部数据包进入Linux系统进行信息过滤
OUTPUT链|主要时对内部Linux系统索要发送的数据包进行信息过滤
FORWARD链|将外面过来的数据包传递到内部计算机中


### 11.1.2. nat表
链名称|链作用
-|-
PREROUTING链|是在数据包刚刚达到防火墙时,根据需要改变它的目的地址,例如DNAT操作,就是通过一个合法的公网IP地址,通过对防火墙的定向,重定向到防火墙内的其他计算机
INPUT链|
OUTPUT链|改变了本地产生包的目的地址
POSTROUTING链|在包就要离开防火墙之前改变其源地址,例如SNAT操作,屏蔽了本地局域网主机的信息,本地主机通过防火墙链接到Inertnet,这样在Internet上看到的本地主机的来源地址都是同一个IP,屏蔽了来源主机信息


### 11.1.3. mangle表
不常用,不记录了

## 11.2. 选项

选项|选项作用描述
-|-
-t|后面接表
-L|--list
-v|显示更多的信息
-n|输出结果用IP显示,显示速度会加快
-F|--flush清空某个指定table中所有链的规则设定
-X|--delete-chain,删除使用者自定义的table chain
-Z|--zero,将数据包计数器归零,数据包计数器是用来统计同一数据包出现的次数


### 11.2.1. 操作选项

选项|选项作用描述
-|-
-A|新增加一条规则,放到已有规则的最后面
-I|插入一条指定规则,如果没有指定插入规则的顺序,则新插入的变成第一条规则
-i|指定数据进入的那个网络接口,Linux下常见的有eth0,eth1.lo等,此参数一般与INPUT链配合使用
-o|指定数据包传出的那个网络接口.经常与OUTPUT链配合使用
-p|指定此规则适用的协议,常用的协议有TCP,UDP,ICMP和ALL
-s|指定来源的IP或者网络,也就是限定数据包来源的IP或者网络,可以单独指定某个IP,也可以指定某段网络
-d|指定目标IP或者网络
-j|此参数后面指定要执行的动作,主要的动作有接受(ACCEPT),抛弃(DROP)及记录(LOG)
ACCEPT|接受该数据包
DROP|直接丢弃该数据包,不给客户端任何回应
REJECT|拦截该数据封包,并发送封包通知对方,可以发送的封包有`icmp-port-unreacgable,tcp-reset,icmp-echo-reply`
REDIRECT|用在nat表中,主要用于将封包请求重定向到另一个端口,处理完毕此规则,将继续比对其他规则

### 11.2.2. 过滤选项
选项|选项作用描述
-|-
--sport 端口范围|限制来源的端口号码,端口号码可以是连续的,例如1024:65535
--dport 端口范围|限制目标的端口号码
-m|模块选项<br/>state: 状态模块<br/>mac: 网卡硬件地址
--state|NEW: 表示这个包是我们看到的第一个包<br/>ESTABLISHED: 表示该封包属于某个已经建立的连接<br/>RELATED: 当一个连接和某个已处于ESTABLISHED状态的连接有关系时,就被认为是RELATED<br/>INVALID: 表示数据包不能被识别属于哪个连接或者没有状态

### 11.2.3. 注意点,用tcp-reset代替drop
* http://blog.csdn.net/q345852047/article/details/7322317


### 11.2.4. 参考书籍的
![](http://ouxarji35.bkt.clouddn.com/snipaste_20170901_073422.png)


# 12. 备份(备份不是万能的,但是没有备份是万万不能的)

## 12.1. 数据备份方式
* 本地备份: 讲数据备份到本地系统的磁盘,磁带或者专有存储设备上,主要时针对系统鼓掌或者黑客攻击等造成的数据丢失情况
* 异地容灾: 对数据和业务安全性考虑更高的指标.主要是将数据备份到另一个城市或者国家,主要是针对可能发生的自然灾害,火灾和水灾

## 12.2. 备份策略
* 完全备份 对于Linux操作系统来说，就是将根分区下的所有文件进行备份,完全备份的好处是：所有数据都进行了备份，系统任何数据丢失都能恢复，并且恢复效率高。它的缺点是备份时间较长，备份了很多无用数据，浪费了存储空间。
* 增量备份  增量备份就是只备份每天增加或者变化的数据，而不备份系统中没有变动的数据，这样备份的数据量就大大减少了，可以缩短备份时间。但是增量备份也有缺点，就是恢复数据时比较复杂，需要用首次完全备份的数据和增量备份数据组合进行恢复，如果有多个增量备份文件，恢复过程将变得十分缓慢。

## 12.3. tar备份案例
```bash
BACKDATE=`date +%y%m%d`
DATA3=`date -d "3 days ago" +%y%m%d`

# 备份
tar -cvzf  /backup/etc.data/etc_$BACKDATE.tar.gz /etc

# 删除3天前的备份
rm -rf  /backup/etc.data/etc_$DATA3.tar.gz
```

## 12.4. rsync备份案例
> 这里我们假定有A、B两个Linux系统，A系统运行业务，B系统作为A的一个远程容灾备份机，那么A系统就是rsync的服务端，B系统就是rsync的客户端。需要在A、B两个系统上都安装rsync软件，这样，在A系统上运行rsync守护进程，而B系统可以通过系统守护进程crontab来定时备份A系统上指定的数据，从而实现了数据的远程容灾。
