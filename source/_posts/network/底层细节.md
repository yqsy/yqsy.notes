---
title: 底层细节
date: 2017-11-07 15:59:39
categories: [网络相关]
---

<!-- TOC -->

- [1. 总览](#1-总览)
- [2. 以太网帧](#2-以太网帧)
- [3. IP服务的特点](#3-ip服务的特点)

<!-- /TOC -->


<a id="markdown-1-总览" name="1-总览"></a>
# 1. 总览
![](http://ouxarji35.bkt.clouddn.com/snipaste_20171107_163348.png)

![](http://ouxarji35.bkt.clouddn.com/snipaste_20171107_163524.png)

分用(demultiplexing)
![](http://ouxarji35.bkt.clouddn.com/snipaste_20171107_164107.png)

`RFC 1700`定义了所有标识上层协议的类型字段以及每个上层协议对应的数值,传输层端口号在`/etc/services`中可以找到

<a id="markdown-2-以太网帧" name="2-以太网帧"></a>
# 2. 以太网帧
![](http://ouxarji35.bkt.clouddn.com/snipaste_20171107_163910.png)

以太网帧使用6字节的目的物理地址和6字节的源物理地址来表示通信的双方,4字节CRC字段对帧的其他部分提供循环冗余校验

<a id="markdown-3-ip服务的特点" name="3-ip服务的特点"></a>
# 3. IP服务的特点

IP为上层提供`无状态(stateless)`,`无连接(connectionless)`,`不可靠()`的服务

* https://en.wikipedia.org/wiki/IPv4#Header

![](http://ouxarji35.bkt.clouddn.com/snipaste_20171107_160542.png)

* 4位版本号(version),对于IPv4来说,其值是4
* 4位头部长度(header length),标识该IP头部有多少个32bit字,因为4位最大能表示15,所以IP头部最长是60字节
* 8位服务类型(Type Of Service, TOS),3:优先权(忽略),4:TOS字段,1:保留(置0),4位TOS字段表示:`最小延时`,`最大吞吐量`,`最高可靠性`,`最小费用`.最多只能有一个置1,比如ssh和telnet需要最小延时,文件传输程序ftp需要最大吞吐量
* 16位总长度(total length)指`整个IP数据报的长度`.最大长度为`65535`字节.但是由于MTU的限制,长度超过MTU的数据都将被`分片传输`,所以`实际传输的IP数据报的长度远远没有达到最大值`
* 16位标识(identification)唯一的标识主机发送的每一个数据包,每发送一个数据报,其值就加1
* 3位标志,第一位保留,第二位(Don't Fragment, `DF`)表示`禁止分片`,在这种情况下,如果IP数据报长度超过MTU的话,IP模块将丢弃该数据包并返回一个ICMP差错报文,第三位(More Fragment, `MF`)表示`更多分片`,除了数据报最后一个分片外,其他分片都要把它置1
* 13位分片偏移(fragmentation offset)是分片相对原始IP数据报开始处,实际的偏移值是该值左移3位(乘8)后得到的,除了最后一个IP分片外,`每个IP分片的数据部分的长度必须是8的整数倍`
* 8位生存时间(Time TO Live,TTL)是数据报到达目的地之前允许经过的路由器跳数,常见(64),当TTL值减为0时,路由器将丢弃数据报,并向源端发送一个ICMP差错报文.`防止数据报陷入路由循环`
* 8位协议(protocol)用来区分上层协议,`/etc/protocols`,ICMP是1,TCP是6,UDP是17,`RFC 1700`
* 16位头部校验和(header checksum)由发送端填充,接收端对其使用CRC算法以检验IP数据报的头部`(!仅检验头部)`
* 32位源端IP地址/目的端IP地址(整个传递过程中保持不变?)
* 选项,参考`RFC 791`
