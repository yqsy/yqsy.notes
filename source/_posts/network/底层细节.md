---
title: 底层细节
date: 2017-11-07 15:59:39
categories: [网络相关]
---

<!-- TOC -->

- [1. 总览](#1-总览)
- [2. 以太网帧](#2-以太网帧)
- [3. IP服务的特点](#3-ip服务的特点)
    - [3.1. IP分片](#31-ip分片)
    - [3.2. IP路由](#32-ip路由)
    - [3.3. IP转发](#33-ip转发)
- [4. IPV6固定头部](#4-ipv6固定头部)

<!-- /TOC -->


<a id="markdown-1-总览" name="1-总览"></a>
# 1. 总览
![](http://ouxarji35.bkt.clouddn.com/snipaste_20171107_163348.png)

![](http://ouxarji35.bkt.clouddn.com/snipaste_20171107_163524.png)

分用(demultiplexing)
![](http://ouxarji35.bkt.clouddn.com/snipaste_20171107_164107.png)

`RFC 1700`定义了所有标识上层协议的类型字段以及每个上层协议对应的数值,传输层端口号在`/etc/services`中可以找到

<a id="markdown-2-以太网帧" name="2-以太网帧"></a>
# 2. 以太网帧
![](http://ouxarji35.bkt.clouddn.com/snipaste_20171107_163910.png)

以太网帧使用6字节的目的物理地址和6字节的源物理地址来表示通信的双方,4字节CRC字段对帧的其他部分提供循环冗余校验

<a id="markdown-3-ip服务的特点" name="3-ip服务的特点"></a>
# 3. IP服务的特点

IP为上层提供`无状态(stateless)`,`无连接(connectionless)`,`不可靠()`的服务

* https://en.wikipedia.org/wiki/IPv4#Header

![](http://ouxarji35.bkt.clouddn.com/snipaste_20171107_160542.png)

* 4位版本号(version),对于IPv4来说,其值是4
* 4位头部长度(header length),标识该IP头部有多少个32bit字,因为4位最大能表示15,所以IP头部最长是60字节
* 8位服务类型(Type Of Service, TOS),3:优先权(忽略),4:TOS字段,1:保留(置0),4位TOS字段表示:`最小延时`,`最大吞吐量`,`最高可靠性`,`最小费用`.最多只能有一个置1,比如ssh和telnet需要最小延时,文件传输程序ftp需要最大吞吐量
* 16位总长度(total length)指`整个IP数据报的长度`.最大长度为`65535`字节.但是由于MTU的限制,长度超过MTU的数据都将被`分片传输`,所以`实际传输的IP数据报的长度远远没有达到最大值`
* 16位标识(identification)唯一的标识主机发送的每一个数据包,每发送一个数据报,其值就加1
* 3位标志,第一位保留,第二位(Don't Fragment, `DF`)表示`禁止分片`,在这种情况下,如果IP数据报长度超过MTU的话,IP模块将丢弃该数据包并返回一个ICMP差错报文,第三位(More Fragment, `MF`)表示`更多分片`,除了数据报最后一个分片外,其他分片都要把它置1
* 13位分片偏移(fragmentation offset)是分片相对原始IP数据报开始处,实际的偏移值是该值左移3位(乘8)后得到的,除了最后一个IP分片外,`每个IP分片的数据部分的长度必须是8的整数倍`
* 8位生存时间(Time TO Live,TTL)是数据报到达目的地之前允许经过的路由器跳数,常见(64),当TTL值减为0时,路由器将丢弃数据报,并向源端发送一个ICMP差错报文.`防止数据报陷入路由循环`
* 8位协议(protocol)用来区分上层协议,`/etc/protocols`,ICMP是1,TCP是6,UDP是17,`RFC 1700`
* 16位头部校验和(header checksum)由发送端填充,接收端对其使用CRC算法以检验IP数据报的头部`(!仅检验头部)`
* 32位源端IP地址/目的端IP地址(整个传递过程中保持不变?)
* 选项,参考`RFC 791`

<a id="markdown-31-ip分片" name="31-ip分片"></a>
## 3.1. IP分片

当IP数据报的长度超过帧的MTU时,它将被分片传输,分片可能发生在发送端,也可能发生在中转路由器上,而且可能在传输过程中被多次分片,但只有在最终的目标机器上,这些分片才会被内核中的IP模块重新组装

![](http://ouxarji35.bkt.clouddn.com/snipaste_20171107_170115.png)

<a id="markdown-32-ip路由" name="32-ip路由"></a>
## 3.2. IP路由

![](http://ouxarji35.bkt.clouddn.com/snipaste_20171107_170235.png)

![](http://ouxarji35.bkt.clouddn.com/snipaste_20171107_171225.png)

IP路由机制的3个步骤

* 1) 查找路由表中数据报的目的IP地址完全匹配的主机IP地址,如果找到,就使用该路由项,没找到则转步骤2
* 2) 查找路由表中和数据报的目标IP地址具有相同网络ID的网络IP地址,如果找到,就使用该路由项,没找到则转步骤3
* 3) 选择默认路由项,这通常意味着数据报的下一跳路由是网关

通过route命令或其他工具手工修改路由表,是静态的路由更新方式,对于大型的路由器,它们通常 通过`BGP(Border Gateway Protocol,边际网关协议)`, `RIP(Routing Information Protocol,路由信息协议)`,OSPF等协议来发现路径,并更新自己的路由表,这种更新方式是动态的,自动的.

<a id="markdown-33-ip转发" name="33-ip转发"></a>
## 3.3. IP转发

```bash
echo "1" > /proc/sys/net/ipv4/ip_forward
```

* 1) 检查数据报头部的TTL值,如果TTL值已经是0,则丢弃该数据报
* 2) 查看数据报头部的严格源路由选择选项,如果该选项被设置,则检查数据报的目标IP地址是否是本机的某个IP地址,如果不是,则发送一个ICMP源站选路失败报文给发送端
* 3) 如果有必要,则给远端发送一个ICMP重定向报文,以高速它一个更合理的下一跳路由器
* 4) 将TTL值减1
* 5) 处理IP头部选项
* 6) 如果有必要,则执行IP分片操作


<a id="markdown-4-ipv6固定头部" name="4-ipv6固定头部"></a>
# 4. IPV6固定头部

![](http://ouxarji35.bkt.clouddn.com/snipaste_20171107_172654.png)

* 4位版本号(version)指定IP协议的版本,对IPV6来说,其值是6
* 8位通信类型(traffic class)指示数据流通信类型或优先级,和IPV4中的TOS类似
* 20位流标签(flow label)是IPV6新增加的字段,用于某些对连接的服务质量有特殊要求的通信,比如音频或视频等实时数据传输
* 16位净荷长度(payload length)指的是IPv6扩展头部和应用程序数据长度之和,不包括固定头部长度
* 8位下一个包头(next header)指出紧跟IPv6固定头部后的包头类型(比如TCP,UDP或ICMP)
* 8位跳数限制(hop limit)和IPv4的TTL含义相同
* IPv6用128位(16字节)来表示IP地址,使得`IPv6使得地球上的每粒沙子都有一个IP地址`

IPv6协议并不是IPv4协议的简单扩展,而是完全独立的协议,用以太网帧封装的IPv6数据报和IPv4数据报具有不同的类型值.见 `RFC 2464`
