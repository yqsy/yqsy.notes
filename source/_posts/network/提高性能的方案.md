---
title: 提高性能的方案
date: 2017-11-10 21:15:44
categories: [网络相关]
---

<!-- TOC -->

- [1. 池](#1-池)
- [2. 数据复制](#2-数据复制)
- [3. 上下文切换和锁](#3-上下文切换和锁)

<!-- /TOC -->

<a id="markdown-1-池" name="1-池"></a>
# 1. 池

浪费服务器的资源,以换取其运行效率,根据不同的资源类型,池可分为多种,常见的有内存池,进程池,线程池和连接池

* `内存池`: 通常用于socket的接收缓存和发送缓存,对于某些长度有限的客户请求,,预先分配一个大小足够的接收缓冲区(5000字节)是很合理的,当客户请求的长度超过接收缓冲区的大小时,我们可以选择丢弃请求或者动态扩大接收缓冲区
* `进程池,内存池`: 当我们需要一个工作进程或工作线程来处理新到来的客户请求时,我们可以直接从进程池或线程池中取得一个执行实体,而无需动态地调用`fork`或`pthread_create`等函数来创建进程和线程
* `连接池`: 每个逻辑单元可能都需要频繁地访问数据库.连接池是服务器预先和数据库程序建立的一组连接的集合,当某个逻辑单元需要访问数据库时,它可以直接从连接池中取得一个连接的实体并使用之.待完成数据库的访问之后,逻辑单元再将该连接返还给连接池

<a id="markdown-2-数据复制" name="2-数据复制"></a>
# 2. 数据复制

`高性能服务器应该避免不必要的数据复制`,尤其是当数据复制发生在用户代码和内核之间的时候.如果内核可以直接处理从socket或者文件读入的数据,则应用程序就没必要讲这些数据从内核缓冲区复制到应用程序缓冲区中.例如`sendfile`

例如两个工作进程之间要传递大量的数据时,我们就应该考虑使用共享内存在它们之间直接共享这些数据,而不是使用管道或者消息队列来传递


<a id="markdown-3-上下文切换和锁" name="3-上下文切换和锁"></a>
# 3. 上下文切换和锁

并发程序必须考虑上下文切换(context switch)的问题,即进程切换或线程切换导致的系统开销,`即使是I/O密集型的服务器,也不应该使用过多的工作线程/工作线程`,否则线程间的切换将占用大量的CPU时间,服务器真正用于处理业务逻辑的CPU时间的比重就显得不足了.

`半同步/半异步`模式以一种比较合理的解决方案,它允许一个线程同时处理多个客户连接,此外,多线程服务器的一个优点是不同的线程可以同时运行在不同的CPU上.`当线程的数量不大于CPU的数目时,上下文的切换就不是问题了`

并发程序需要考虑的另外一个问题是共享资源的加锁保护.锁通常被认为是导致服务器效率低下的一个因素,因为由它引入的代码不仅不处理任何业务逻辑,而且需要访问内核资源.因此,服务器如果有更好的解决方案,`就应该避免使用锁`

如果服务器必须使用锁,`则可以考虑减小锁的粒度,比如使用读写锁`.当所有工作线程都只读取一块共享内存的内容时,读写所并不会增加系统的额外开销,只有当其中某一个工作线程需要些这块内存时,系统才必须去锁住这块区域

