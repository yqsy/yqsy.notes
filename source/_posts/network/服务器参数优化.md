---
title: 服务器参数优化
date: 2017-11-19 22:58:21
categories: [网络相关]
---

<!-- TOC -->

- [1. 资源](#1-资源)
- [2. 所有的内核参数](#2-所有的内核参数)
- [3. 最大描述符](#3-最大描述符)
- [4. /proc/sys/fs](#4-procsysfs)
- [5. /proc/sys/net](#5-procsysnet)
- [6. 验证最大打开文件数](#6-验证最大打开文件数)
- [7. 验证tcp内核缓冲区](#7-验证tcp内核缓冲区)

<!-- /TOC -->

<a id="markdown-1-资源" name="1-资源"></a>
# 1. 资源

* http://blog.csdn.net/wuji0447/article/details/78354574 (简单参考下)
* http://man7.org/linux/man-pages/man7/tcp.7.html (tcp 优化参数)


<a id="markdown-2-所有的内核参数" name="2-所有的内核参数"></a>
# 2. 所有的内核参数

```bash
# 查看所有内核参数
sysctl -a
```

永久修改方法:
* 修改/etc/sysctl.conf 并执行sysctl -p使之生效

<a id="markdown-3-最大描述符" name="3-最大描述符"></a>
# 3. 最大描述符

* https://docs.oracle.com/cd/E19623-01/820-6168/file-descriptor-requirements.html (文件描述符)
* https://docs.oracle.com/cd/E23389_01/doc.11116/e21036/perf002.htm

```bash
# 查看用户级文件描述符数限制
ulimit -n

# 系统最大
cat /proc/sys/fs/file-max

# 系统已分配 未分配 最大分配
cat /proc/sys/fs/file-nr

# 临时将用户级文件描述符数限制为max-file-number
ulimit -SHn 65535

echo "ulimit -SHn 65535" | sudo tee --append /etc/rc.local > /dev/null

# 查看说明
man 5 limits.conf

# 永久修改用户级文件描述符数限制
vim /etc/security/limits.conf

*hard nofile max-file-number
*soft nofile max-file-number
```

<a id="markdown-4-procsysfs" name="4-procsysfs"></a>
# 4. /proc/sys/fs
与文件系统相关

* /proc/sys/fs/file-max: 系统级文件描述符数限制(临时修改)
* /proc/sys/fs/epoll/max_user_watches: 一个用户能够往epoll内核事件表中注册的事件的总量.它是指该用户打开的所有epoll实例总共能监听的事件数目,而不是单个epoll实例能监听的事件数目.往epoll内核事件表中注册一个事件,在32位系统上大概消耗90字节的内核控件,在64位系统上则消耗160字节的内核空间.所以这个内核参数限制了epoll使用的内核内存总量.

<a id="markdown-5-procsysnet" name="5-procsysnet"></a>
# 5. /proc/sys/net
网络模块相关

* /proc/sys/net/core/somaxconn: 指定listen监听队列里,能够建立完整连接从而进入ESTABLISHED或者SYN_RCVD状态的socket的最大数目
* /proc/sys/net/ipv4/tcp_max_syn_backlog: 指定listen监听队列里,能够转移至ESTAB-LISHED或者STB_RCVD状态的socket的最大数目
* /proc/sys/net/ipv4/tcp_wmem: TCP写缓冲区的最小值,默认值和最大值
* /proc/sys/net/ipv4/tcp_rmem: TCP读缓冲区的最小值,默认值和最大值
* /proc/sys/net/ipv4/tcp_syncookies: 指定是否打开TCP同步标签(syncookie).同步标签通过启动cookie来防止一个监听socket因不停地重复接收来自同一个地址的连接请求(同步报文段),而导致listen监听队列溢出(所谓SYN风暴)


<a id="markdown-6-验证最大打开文件数" name="6-验证最大打开文件数"></a>
# 6. 验证最大打开文件数

```python
fs = []
for  i in range(10000):
    f = open('{}'.format(i), "w+")
    fs.append(f)

```

```bash
# 删除
ls -l | awk '{print $9}' | sort -n

for i in $(seq 0 1012); do rm $i; done
```


<a id="markdown-7-验证tcp内核缓冲区" name="7-验证tcp内核缓冲区"></a>
# 7. 验证tcp内核缓冲区

* https://www.zhihu.com/question/25713113/answer/31584922 (TCP接收缓冲区何时真正分配空间)
* http://blog.csdn.net/russell_tao/article/details/18711023

```python

import socket

server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

server.bind(('0.0.0.0', 8080))
server.listen(1)
conn, addr = server.accept()

```

```bash
dd if=/dev/zero bs=1MB count=1024 | nc localhost 8080
```

```bash
# TCP performs receive buffer auto-tuning, attempting to automatically size the buffer
net.ipv4.tcp_moderate_rcvbuf

# This is a vector of 3 integers: [min, default, max]. These parameters are used by TCP to regulate receive buffer sizes.
net.ipv4.tcp_rmem

# This is a vector of 3 integers: [min, default, max]. These parameters are used by TCP to regulate send buffer sizes.
net.ipv4.tcp_wmem
# This is a vector of 3 integers: [low, pressure, high].
net.ipv4.tcp_mem

net.core.wmem_default
net.core.wmem_max

net.core.rmem_default
net.core.rmem_max

```
