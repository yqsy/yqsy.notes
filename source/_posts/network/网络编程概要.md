---
title: 网络编程概要
date: 2017-11-07 20:15:44
categories: [网络相关]
---

<!-- TOC -->

- [1. 概要](#1-概要)
- [2. 测试吞吐量的方法](#2-测试吞吐量的方法)
    - [2.1. 理论](#21-理论)
    - [2.2. 实际](#22-实际)
- [3. 例子](#3-例子)
- [4. What performance do we care](#4-what-performance-do-we-care)
- [5. 每个连接占用多少字节](#5-每个连接占用多少字节)

<!-- /TOC -->


<a id="markdown-1-概要" name="1-概要"></a>
# 1. 概要

应用层程序员只需要关注4层:

* Etnernet framse 以太网: 帧
* IP packet : 分组 (不是分片)
* TCP segment: 分节
* Application message: 消息

<a id="markdown-2-测试吞吐量的方法" name="2-测试吞吐量的方法"></a>
# 2. 测试吞吐量的方法

```bash
# 主机监听
nc -l 5001 > /dev/null

# 显示进度条(显示的是MiB)
nc -l 5001 | pv -W > /dev/null

# 向主机发送
dd if=/dev/zero bs=1MB count=1000 | nc 192.168.2.153 5001
```

<a id="markdown-21-理论" name="21-理论"></a>
## 2.1. 理论

* https://en.wikipedia.org/wiki/Data_rate_units

关于K M G的算法是使用二进制还是十进制

领域|计算方式
-|-
计算机数据传送速度|十进制
硬盘生产商|十进制
操作系统|二进制

1Gb Ethernet: 1Gb/s = 125MB/s = 125,000,000B/s (Raw bandwidth)

Ethernet frame Total 84 ~ 1538 B

字段|长度
-|-
Preamble|7 B
Start of frame delimiter|1 B
MAC destination|6 B
MAC source|6 B
Ethertype|2 B
Payload|46-1500 B
CRC|4 B
Gap|12 B

Packet per second

* Max 125,000,000 / 84 = 1,488,000
* Min 125,000,000 / 1538 = 81,274

TCP/IP overhead
* IP header 20B
* TCP header 20B
* TCP option 12B

Max TCP throughput:
* 81,274 * (1500 - 52) = 117,684,752 = 117MB/S 或 112Mib/S

所以千兆带宽使用TCP传输数据的速度是117MB/S,百兆带宽是11.7MB/S

<a id="markdown-22-实际" name="22-实际"></a>
## 2.2. 实际
树莓派向虚拟机发送1G  
1000000000 bytes (1.0 GB) copied, 85.0122 s, 11.8 MB/s  (百兆网卡)

虚拟机向自己发送10G  
10000000000 bytes (10 GB) copied, 12.2552 s, 816 MB/s  
![](http://ouxarji35.bkt.clouddn.com/snipaste_20171125_093510.png)

<a id="markdown-3-例子" name="3-例子"></a>
# 3. 例子

Basic,non-concurrent examples
* TTCP: classic TCP performance testing  tool
* Round-trip: measure clock error bwtween two hosts (udp)
* Netcat: a Swiss knife
* Slow sink/source (慢速收发工具)

Concurrent examples
* SOCKS proxy server
* Sudoku solver
* Simple memcached
* Broadcasting to multiple TCP peers

Data processing with multiple machines (hadoop或spark现成)
* Parallel N-queues
* Median of numbers accross machines
* Frequent queries (找出日志最频繁的查询)
* Distributed sorting (分布式排序 (MapReduce))

Advanced topics
* RPC - A basic building block for various servers
* Load balancing (Better than round-robin)
* Capacity of a serving system (How many machines do i need to support X QPS?)
* Fight for latency (测延时)

<a id="markdown-4-what-performance-do-we-care" name="4-what-performance-do-we-care"></a>
# 4. What performance do we care

* Bandwidth, MB/s
* Throughput, messages/s,queries/s(QPS),transactions/s(TPS)
* Latency,milliseconds,percentiles
* Utilization, percent, payload (资源使用率)vs. carrier,goodputs vs. theory BW
* Overhead(额外开销), eg. CPU usage, for compression and/or encryption


<a id="markdown-5-每个连接占用多少字节" name="5-每个连接占用多少字节"></a>
# 5. 每个连接占用多少字节

* https://zhuanlan.zhihu.com/p/25241630